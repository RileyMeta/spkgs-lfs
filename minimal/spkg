#!/bin/bash
set -e

REPO="https://lfs.gnlug.org/pub/lfs/lfs-packages/12.4/"
PKG_DIR="/mnt/lfs/sources"
USER_AGENT="Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0"

get_pkg() {
    local name="$1"

    [[ -z "$name" ]] && { echo "Usage: spkg <package>"; return 1; }
    [[ ! -d "$PKG_DIR" ]] && { mkdir -pv "$PKG_DIR"; }

    echo "Searching for $name..."

    # Fetch HTML and grep for filename
    local path
    path=$(curl -fsSL "$REPO" -A "$USER_AGENT" \
        | grep -oE "$name[^\"]*\.tar\.[^\" ]+" \
        | head -n 1)

    if [[ -z "$path" ]]; then
        echo "Package not found."
        exit 1
    fi

    echo -e "$path ... [FOUND]"
    curl -fsSL -A "$USER_AGENT" "$REPO/$path" -o "$PKG_DIR/$path"
    echo -e "Name: $path\nLocation: $PKG_DIR$path"
}

get_pkg "$@"
